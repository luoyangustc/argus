set(shadow_cpu_src)
set(shadow_gpu_src)
set(shadow_examples_src)
set(shadow_test_src)

add_subdirectory(core)
add_subdirectory(examples)
add_subdirectory(operators)
add_subdirectory(proto)
add_subdirectory(util)

if (${BUILD_TEST})
  add_subdirectory(test)
endif ()

include_directories(".")

if (${USE_CUDA} AND CUDA_FOUND)
  cuda_add_library(shadow ${shadow_cpu_src} ${shadow_gpu_src})
else ()
  add_library(shadow ${shadow_cpu_src})
endif ()
target_link_libraries(shadow ${Shadow_LINKER_LIBS})
if (Protobuf_FOUND)
  target_link_libraries(shadow ${Shadow_PROTO_LIB} ${Protobuf_LIBRARIES})
endif ()
if (MSVC)
  set_target_properties(shadow PROPERTIES DEBUG_POSTFIX "d")
endif ()
install(TARGETS shadow DESTINATION ${Shadow_INSTALL_LIB_PREFIX})
install(DIRECTORY core util DESTINATION ${Shadow_INSTALL_INCLUDE_PREFIX} FILES_MATCHING PATTERN "*.hpp" PATTERN "*.h")
if (Protobuf_FOUND)
  install(DIRECTORY proto DESTINATION ${Shadow_INSTALL_INCLUDE_PREFIX} FILES_MATCHING PATTERN "*.hpp" PATTERN "*.h")
endif ()

if (BUILD_SHARED_LIBS)
  set(Shadow_LIB shadow)
else ()
  add_whole_archive_flag(shadow Shadow_LIB)
endif ()

if (${BUILD_EXAMPLES})
  foreach (shadow_example_src ${shadow_examples_src})
    get_filename_component(shadow_example_fil_we ${shadow_example_src} NAME_WE)
    add_executable(${shadow_example_fil_we} ${shadow_example_src})
    target_link_libraries(${shadow_example_fil_we} shadow)
    install(TARGETS ${shadow_example_fil_we} DESTINATION ${Shadow_INSTALL_BIN_PREFIX})
  endforeach ()
endif ()

if (${BUILD_TEST})
  add_executable(test_shadow ${shadow_test_src})
  target_link_libraries(test_shadow ${Shadow_LIB})
  install(TARGETS test_shadow DESTINATION ${Shadow_INSTALL_BIN_PREFIX})
endif ()
